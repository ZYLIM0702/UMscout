<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- FullCalendar CSS and JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.13/html-to-image.js" integrity="sha512-4W7+nCTcMQMFBnTRwvixN7il649NCqZiBfJ7WvzU7gxF12zOnaKwVYTSIzwrjy/cy+CPQxn2lAIVZIes+rPp2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <!-- ical.js for ICS parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
  <!-- noUiSlider CSS and JS for dual slider -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <!-- Font Awesome for icons (example) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
        :root {
    --fc-today-bg-color: transparent;
    }
body {
  margin: 0; /* Remove default margin */
  min-height: 100vh; /* Full viewport height */
  display: flex;
  flex-direction: column;
  justify-content: flex-end; /* Push content to the bottom */
  font-family: Arial, sans-serif;
  background-color: #000;
  color: black;
}
    /* The “real” calendar container with a fixed height and dynamic width */
    #calendar {
      height: 1900px; /* fixed height */
    }
    /* This viewport will show only the timeline (no header) at fixed size */
    #timelineViewport {
  width: 360px;
  height: 460px;
  overflow: hidden;
  position: relative;
  margin: 20px auto;
}

/* Tablet (iPad) - Adjusts based on orientation */
@media (min-width: 769px) {
  #timelineViewport {
    width: 800px;
    height: 450px;
  }

  @media (orientation: portrait) {
    #timelineViewport {
      width: 700px;
      height: 750px;
    }
  }
}
    /* Loading overlay styles */
    #loadingOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgb(0, 0, 0);
      z-index: 10;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* FullCalendar scaling style */
    #calendar.scaled {
      transform-origin: top left;
    }
    /* Other styles remain unchanged... */
    .fc .fc-view-harness {
      background-color: #fff;
      border-radius: 20px;
      overflow: hidden;
    }
    .fc .fc-toolbar-title { color: white; font-size: 4rem;}
    .fc .fc-button-group {
      border-radius: 20px;
      overflow: hidden;
    }
    .fc .fc-button-primary {
      background-color: #fff;
      color: #000;
      border: none;
    }
    .card-event {
      border-radius: 14px !important;
      padding: 8px;
      border: none !important;
      color: #fff;
      overflow: hidden;
    }
    .toggle-scroll {
    text-align: center;
    justify-content: space-evenly;
    display: flex
;
    flex-direction: row;
}
    .toggle-item {
      display: inline-block;
      margin: 0 5px;
      text-align: center;
      align-items: center;
      align-self: center;
    }
    .toggle-item i { font-size: 1.2rem; color: #fff; }
    .cupertino-switch {
        margin-top: 10px;
      position: relative;
      display: inline-block;
      width: 35px;
      height: 20px;
      vertical-align: middle;
    }
    .fc-event-main{
        display: none;
    }
    .cupertino-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #e9e9eb;
      border-radius: 16px;
      transition: .4s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 0px;
      background-color: #fff;
      border-radius: 50%;
      transition: .4s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 0.5px rgba(0, 0, 0, 0.1);
    }
    .noUi-tooltip { display: none; }
    input:checked + .slider {
      background-color: #573aff;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 0.5px rgba(0, 0, 0, 0.1);
    }
    .noUi-target {
      background: #e9e9eb;
      border-radius: 8px;
      border: none;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .noUi-connect { background: #573aff; }
    .noUi-horizontal { height: 6px; }
    .noUi-handle:after, .noUi-handle:before { background: none; }
    .noUi-horizontal .noUi-handle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
    }
    .noUi-handle:focus { outline: none; transform: scale(1.15); }
    .slider-row {
    display: flex;
    gap: 20px;
    margin: 20px 20px 0px;
    border-radius: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
    justify-content: center;
    align-items: flex-start
}
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: white;
      letter-spacing: -0.08px;
      margin-top: 8px;
    }
    select {
      padding: 8px 12px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #fff;
      font-size: 13px;
      color: #1d1d1f;
      transition: border-color 0.2s ease;
    }
    select:focus {
      outline: none;
      border-color: #573aff;
      box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
    }
    .fc-col-header-cell {
      background-color: #6e24f9;
      color: #fff;
      font-weight: bold;
      padding: 10px 0 !important;
    }
    .fc .fc-timegrid-slot-minor { border-top-style: none; }
    .fc-theme-standard td, .fc-theme-standard th { border: 1px solid #e5e5e5; }
    .fc-theme-standard td:first-child,
    .fc-theme-standard th:first-child {
        border-left: none; /* Remove right border for the first column */
    }

    .fc-theme-standard td:last-child,
    .fc-theme-standard th:last-child {
        border-right: none; /* Remove left border for the last column */
    }

    .fc-theme-standard td:first-child ,
    .fc-theme-standard tr:first-child th {
        border-top: none; /* Remove top border for the first row */
    }

    .fc-theme-standard tr:last-child td,
    .fc-theme-standard tr:last-child td {
        border-bottom: none; /* Remove bottom border for the last row */
    }

    .fc-timegrid-axis {
      background-color: #2a78ff;
      color: #fff ;
      font-weight: bold;
    }
    .fc-direction-ltr .fc-timegrid-slot-label-frame {
      text-align: left;
      color: #fff;
      font-weight: bold;
      margin: 15px;
    }
    .fc-direction-ltr .fc-timegrid-col-events { margin: 1px 2px 0px 2px; }
    .fc-timegrid-event-harness-inset .fc-timegrid-event, .fc-timegrid-event.fc-event-mirror, .fc-timegrid-more-link{
      box-shadow: none;
    }
    .custom-dropdown {
    position: relative;
    display: inline-block;
    font-size: 14px;
    flex: 1;
    color: #333;
    background: #fff;
    border-radius: 20px;
    cursor: pointer;
    user-select: none;
  }
  .custom-dropdown .selected-option {
    padding: 8px 12px;
  }
  .custom-dropdown .dropdown-options {
    display: none;
    position: absolute;
    bottom: 100%; /* Positioning options above the selected option */
    left: 0;
    right: 0;
    background: #fff;
    border-bottom: none;
    overflow-y: auto;
    z-index: 1000;
    padding-left: 15px;
    border-radius: 15px;
  }
  .custom-dropdown .dropdown-options li {
    padding: 8px 12px;
    list-style: none;
  }
  .custom-dropdown .dropdown-options li:hover {
    background: #f0f0f0;
  }
  .fc-theme-standard .fc-scrollgrid{
    border: none !important;
  }
  </style>
</head>
<body>
  <!-- Container for header outside the timeline viewport -->
  <div id="calendarHeader" style="max-width:900px; margin:20px auto; text-align:center; color:#fff;"></div>
  <!-- Timeline viewport for the timeline part only -->
  <div id="timelineViewport">
    <!-- Loading overlay with spinner -->
    <div id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    <div id="calendar" ></div>
  </div>
    <!-- Horizontally scrollable toggles -->
    <div class="settings-panel">
        <div class="toggle-scroll">
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-days"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleOCC" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-list"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleCategory" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-user"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleLecturer">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-clock"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleTime" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-location-dot"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleLocation" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-check"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleWeekend">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-alt"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleDateHeader">
              <span class="slider"></span>
            </label>
          </div>
            <!-- New Color Theme Dropdown -->

        </div>
      </div>
      <div style="margin-top: 20px;display: flex;gap:15px;flex-direction: row;justify-content: space-around;padding: 0px 20px;">
        <select id="colorThemeDropdown" style="padding: 6px; border-radius: 15px; border: none;">
          <option value="default">Default</option>
          <option value="classic">Classic</option>
          <option value="beigeTan">Beige Tan</option>
          <option value="tealOrange">Teal Orange</option>
          <option value="midnightPurple">Midnight Purple</option>
          <option value="forestGreen">Forest Green</option>
          <option value="blackWhite">Black White</option>
    
        </select>
          <select id="heightRatioDropdown" style="padding: 6px; border-radius: 15px; border: none;">
            <option value="5:3">5:3</option>
            <option value="16:9">16:9</option>
            <option value="9:16">9:16</option>
            <option value="3:4">3:4</option>
            <option value="1:1">1:1</option>
          </select>
        
      </div>
    
  <!-- Slider and dropdown row -->
  <div class="slider-row">
    <div style="flex:1">
      <div id="timeRangeSlider"></div>
      <div class="slider-labels">
        <span id="timeRangeStartLabel">08:00</span>
        <span id="timeRangeEndLabel">19:00</span>
      </div>
    </div>

  </div>
  <div style="text-align:center; margin: 15px 15px 30px;">
    <button id="saveImageBtn" style="padding: 10px 20px; font-size: 1rem;width: 100%;border-radius: 20px;border: none;background-color: #573aff;color: white;">Save as PNG</button>
  </div>
  

  <script>

    // Define theme presets – for now, we only have "classic"
    const themes = {
  classic: {
    calendarBackground: '#222831',
    textColor: '#fcca46',
    headerBackground: '#333333',
    timegridBackground: '#222831',
    eventBackground: '#fcca46',
    eventTextColor: '#222831'
  },
  default: {
    calendarBackground: '',
    textColor: '',
    headerBackground: '',
    timegridBackground: '',
    eventBackground: '',
    eventTextColor: ''
  },
  beigeTan: {
    calendarBackground: '#f5f5dc',
    textColor: '#8b5e3c',
    headerBackground: '#d2b48c',
    timegridBackground: '#faebd7',
    eventBackground: '#8b5e3c',
    eventTextColor: '#fff'
  },
  tealOrange: {
    calendarBackground: '#003d59',
    textColor: '#ffa500',
    headerBackground: '#414a4f',
    timegridBackground: '#003d59',
    eventBackground: '#ffaa45',
    eventTextColor: '#003d59'
  },
  midnightPurple: {
    calendarBackground: '#2c003e',
    textColor: '#d8b5ff',
    headerBackground: '#3b005e',
    timegridBackground: '#4a0072',
    eventBackground: '#d8b5ff',
    eventTextColor: '#2c003e'
  },
  forestGreen: {
    calendarBackground: '#1b5e20',
    textColor: '#c8e6c9',
    headerBackground: '#2e7d32',
    timegridBackground: '#388e3c',
    eventBackground: '#c8e6c9',
    eventTextColor: '#1b5e20'
  },
  blackWhite: {
    calendarBackground: '#000000',
    textColor: '#ffffff',
    headerBackground: '#1a1a1a',
    timegridBackground: '#000000',
    eventBackground: '#ffffff',
    eventTextColor: '#000000'
  }

};

// Helper function to apply the selected theme
function applyTheme(themeKey) {
  const theme = themes[themeKey];
  const calendarEl = document.querySelector('.fc-view-harness.fc-view-harness-active');

  // Override the overall calendar background if specified
  if (theme.calendarBackground) {
    calendarEl.style.backgroundColor = theme.calendarBackground;
  } else {
    calendarEl.style.backgroundColor = '';
  }

  // Update header cells background and text color
  document.querySelectorAll('.fc-col-header-cell').forEach(cell => {
    cell.style.backgroundColor = theme.headerBackground || '';
    cell.style.color = theme.textColor || '';
  });
  document.querySelectorAll('.fc-timegrid-axis').forEach(cell => {
    cell.style.backgroundColor = theme.headerBackground || '';
    cell.style.color = theme.textColor || '';
  });
  document.querySelectorAll('.fc-direction-ltr .fc-timegrid-slot-label-frame').forEach(cell => {
    cell.style.color = theme.headerBackground || '';
    cell.style.color = theme.textColor || '';
  });

  // Update the timegrid area background (adjust selector as needed)
  document.querySelectorAll('.fc-timegrid-slots').forEach(slot => {
    slot.style.backgroundColor = theme.timegridBackground || '';
  });

  

}



const urlParams = new URLSearchParams(window.location.search);
const icsUrl = urlParams.get('icsUrl');
var downloadTriggered = false; // Prevents multiple downloads


function getCacheICS(url, cacheDuration = 180) {
  const cacheKey = 'cachedICS';
  const timestampKey = 'cachedICSTimestamp';

  // Check for cached data
  const cachedData = localStorage.getItem(cacheKey);
  const cachedTimestamp = localStorage.getItem(timestampKey);

  if (cachedData && cachedTimestamp) {
    const ageInSeconds = (Date.now() - parseInt(cachedTimestamp, 10)) / 1000;
    if (ageInSeconds < cacheDuration) {
      console.log('Returning cached ICS data');
      return Promise.resolve(cachedData);
    }
  }

  // If no valid cache exists, fetch new data
  return fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();
    })
    .then(data => {
      localStorage.setItem(cacheKey, data);
      localStorage.setItem(timestampKey, Date.now().toString());
      console.log('Fetched new ICS data and updated cache');
      return data;
    })
    .catch(error => {
      console.error('Error fetching ICS data:', error);
      throw error;
    });
}
window._base64Image = "";

function getImageData() {
  return window._base64Image || "";
}

document.getElementById('saveImageBtn').addEventListener('click', function() {
});

function generateAndSaveImage() {
  const calendarEl = document.getElementById('calendar');
const headerEl = calendarEl.querySelector('.fc-header-toolbar');

// Temporarily hide the header
if (headerEl) {
  headerEl.style.visibility = 'hidden';
}

htmlToImage.toCanvas(calendarEl, {
  pixelRatio: 20, // Lower this to a reasonable value (e.g., 2 for HD)
  backgroundColor: null,
  quality:1,
  
  useCORS: true
}).then(canvas => {
  // Restore the header after capturing
  if (headerEl) {
    headerEl.style.visibility = '';
  }

  const ctx = canvas.getContext('2d');
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const pixels = imgData.data;
  const width = canvas.width;
  const height = canvas.height;

  // Find the bounding box of the content
  let left = width;
  let right = 0;
  let top = height;
  let bottom = 0;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const index = (y * width + x) * 4;
      const alpha = pixels[index + 3];
      if (alpha !== 0) {
        if (x < left) left = x;
        if (x > right) right = x;
        if (y < top) top = y;
        if (y > bottom) bottom = y;
      }
    }
  }

  // Calculate the content dimensions
  const contentWidth = right - left + 1;
  const contentHeight = bottom - top + 1;

  // Create the cropped canvas
  const croppedCanvas = document.createElement('canvas');
  const croppedCtx = croppedCanvas.getContext('2d');

  // Set dimensions to match the content's bounding box
  croppedCanvas.width = contentWidth;
  croppedCanvas.height = contentHeight;

  // Copy the relevant portion of the original canvas
  croppedCtx.drawImage(
    canvas,
    left, top, // Source position
    contentWidth, contentHeight, // Source size
    0, 0, // Destination position
    contentWidth, contentHeight // Destination size
  );

  // Convert to data URL and trigger download
  const base64Image = croppedCanvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = base64Image;
  link.download = `UMscout_Timetable_${Date.now()}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
}

let isInitializing = true; // Flag to prevent URL update loops during initialization

// Function to update the URL with new parameters
function updateURL(params) {
  const currentParams = new URLSearchParams(window.location.search);
  for (const [key, value] of Object.entries(params)) {
    if (value === null) {
      currentParams.delete(key);
    } else {
      currentParams.set(key, value);
    }
  }
  const newUrl = `${window.location.pathname}?${currentParams}`;
  history.pushState(null, '', newUrl);
}



    document.addEventListener('DOMContentLoaded', function () {
      const params = new URLSearchParams(window.location.search);
      const isDownload = params.has('download');

  // Initialize calendar with weekStart/weekEnd from URL
  let initialDate;
  const weekStartParam = params.get('weekStart');
  const weekEndParam = params.get('weekEnd');
  if (weekStartParam && weekEndParam) {
    initialDate = weekStartParam; // Use start date to center the view
  }



// Initialize toggles
  // Initialize toggles (default to the ones above)
  document.querySelectorAll('.cupertino-switch input').forEach(toggle => {
    const paramName = toggle.id;
    const paramValue = params.get(paramName);
    // Use URL parameters if present, else fall back to defaults
    toggle.checked = paramValue === '1' || 
      (paramName === 'toggleOCC' && true) || // Default ON
      (paramName === 'toggleCategory' && true) || // Default ON
      (paramName === 'toggleTime' && true) || // Default ON
      (paramName === 'toggleLocation' && true); // NEW: Default ON

    // Trigger change event to apply settings
    toggle.dispatchEvent(new Event('change'));
  });


// Initialize slider
const timeStartParam = params.get('timeStart');
const timeEndParam = params.get('timeEnd');
if (timeStartParam && timeEndParam) {
  timeSlider.noUiSlider.set([parseFloat(timeStartParam), parseFloat(timeEndParam)]);
}

// Initialize dropdowns
const themeParam = params.get('theme');
if (themeParam) {
  const colorDropdown = document.getElementById('colorThemeDropdown');
  colorDropdown.value = themeParam;
  colorDropdown.dispatchEvent(new Event('change'));
}

const ratioParam = params.get('ratio');
if (ratioParam) {
  const ratioDropdown = document.getElementById('heightRatioDropdown');
  ratioDropdown.value = ratioParam;
  ratioDropdown.dispatchEvent(new Event('change'));
}

// Finish initialization
isInitializing = false;

      // Fixed calendar height
      const fixedHeight = 1900;
      let fixedWidth = fixedHeight; // default, updated based on ratio

      function initCustomDropdown(dropdownId) {
      var selectEl = document.getElementById(dropdownId);
      if (!selectEl) return;
      
      // Create a container for the custom dropdown
      var container = document.createElement('div');
      container.className = 'custom-dropdown';
      
      // Create element to display the selected option
      var selected = document.createElement('div');
      selected.className = 'selected-option';
      selected.textContent = selectEl.options[selectEl.selectedIndex].text;
      container.appendChild(selected);
      
      // Create the dropdown list container
      var optionsList = document.createElement('ul');
      optionsList.className = 'dropdown-options';
      
      // Populate the custom dropdown list with options from the native select
      for (var i = 0; i < selectEl.options.length; i++) {
        var li = document.createElement('li');
        li.textContent = selectEl.options[i].text;
        li.dataset.value = selectEl.options[i].value;
        li.addEventListener('click', function(e) {
          var value = this.dataset.value;
          selected.textContent = this.textContent;
          selectEl.value = value;
          optionsList.style.display = 'none';
          // Optionally, trigger a change event if needed
          selectEl.dispatchEvent(new Event('change'));
        });
        optionsList.appendChild(li);
      }
      container.appendChild(optionsList);

      // Toggle the options list when clicking on the selected element
      selected.addEventListener('click', function(e) {
        e.stopPropagation();
        optionsList.style.display = optionsList.style.display === 'block' ? 'none' : 'block';
      });
      
      // Close dropdown if clicking outside
      document.addEventListener('click', function(e) {
        optionsList.style.display = 'none';
      });
      
      // Insert the custom dropdown before the native select element
      selectEl.parentNode.insertBefore(container, selectEl);
      // Hide the native select element
      selectEl.style.display = 'none';
    }
    
    // Initialize custom dropdowns for the desired elements
    initCustomDropdown('colorThemeDropdown');
    initCustomDropdown('heightRatioDropdown');
      
      // Compute fixed width based on the ratio dropdown
      function updateCalendarDimensions() {
  const fixedHeight = 1900;
  const ratioValue = document.getElementById('heightRatioDropdown').value; // e.g. "9:16"
  const [w, h] = ratioValue.split(':').map(Number);
  const fixedWidth = fixedHeight * (w / h);

  // Force #calendar to that width
  const calendarEl = document.getElementById('calendar');
  calendarEl.style.width = fixedWidth + "px";

  // Adjust font size based on the ratio selected
  let fontSize;
  switch (ratioValue) {
    case "16:9":
      fontSize = "2.1rem";
      break;
    case "9:16":
      fontSize = "1.4rem";
      break;
    case "5:3":
      fontSize = "2rem";
      break;
    case "3:4":
      fontSize = "1.4rem";
      break;
    case "1:1":
      fontSize = "1.6rem";
      break;
    default:
      fontSize = "1.2rem";
  }
  calendarEl.style.fontSize = fontSize;

  // Force the harness
  const harnessEl = calendarEl.querySelector('.fc-view-harness');
  if (harnessEl) {
    harnessEl.style.width = fixedWidth + "px";
    harnessEl.style.maxWidth = fixedWidth + "px";
  }

  // Force the timegrid table
  const timelineTable = calendarEl.querySelector('.fc-timegrid-cols > table');
  if (timelineTable) {
    timelineTable.style.width = fixedWidth + "px";
    timelineTable.style.maxWidth = fixedWidth + "px";
  }
}

// Function to convert hex to rgba with reduced opacity
function makeColorPaler(hex, factor = 0.3) {
  let r = parseInt(hex.slice(1, 3), 16);
  let g = parseInt(hex.slice(3, 5), 16);
  let b = parseInt(hex.slice(5, 7), 16);

  // Blend with white by shifting each channel closer to 255
  r = Math.round(r + (255 - r) * factor);
  g = Math.round(g + (255 - g) * factor);
  b = Math.round(b + (255 - b) * factor);

  return `rgb(${r}, ${g}, ${b})`;
}



  
      updateCalendarDimensions();
      
      // Listen for changes in the dropdown to adjust dimensions accordingly.
      document.getElementById('heightRatioDropdown').addEventListener('change', function() {
        calendar.refetchEvents();
        updateCalendarDimensions();
        calendar.updateSize();
        scaleTimeline();

        // Update URL only if not initializing
        if (!isInitializing) {
          updateURL({ ratio: this.value });
        }
      });
      
      // Function to determine the day header format based on toggle state.
      function getDayHeaderFormat() {
        return document.getElementById('toggleDateHeader').checked
          ? { weekday: 'short', month: 'numeric', day: 'numeric' }
          : { weekday: 'short' };
      }
      
      // Create the calendar instance.
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        initialDate: initialDate || new Date(), // Default to today if no parameters
        height: fixedHeight,
        headerToolbar: { left: '', center: '', right: 'prev,next' },
        datesSet: function(dateInfo) {
          scaleTimeline();
          calendar.refetchEvents();
          updateCalendarDimensions();
          calendar.updateSize();
          applyTheme(document.getElementById('colorThemeDropdown').value);

          // Capture current week's start and end dates
          const weekStart = dateInfo.start.toISOString().split('T')[0];
          const weekEnd = dateInfo.end.toISOString().split('T')[0];
          
          // Update URL with weekStart and weekEnd parameters
          if (!isInitializing) {
            updateURL({ weekStart, weekEnd });
            
          }
          


        },
        eventsSet: function() {
    if (window.location.search.includes('download') && !downloadTriggered) {
      downloadTriggered = true;
      setTimeout(() => generateAndSaveImage(), 3000);
    }
  },
        allDaySlot: false,
        slotMinTime: "08:00:00",
        slotMaxTime: "19:00:00",
        expandRows: true,
        weekends: document.getElementById('toggleWeekend').checked,
        events: function(fetchInfo, successCallback, failureCallback) {
          getCacheICS(icsUrl)
    .then(data => {
              const jcalData = ICAL.parse(data);
              const comp = new ICAL.Component(jcalData);
              const vevents = comp.getAllSubcomponents('vevent');
              const fcEvents = [];
              const rangeStart = fetchInfo.start;
              const rangeEnd = fetchInfo.end;
              
              vevents.forEach(event => {
                const vevent = new ICAL.Event(event);
                const eventStart = vevent.startDate.toJSDate();
                const eventEnd = vevent.endDate.toJSDate();
                const duration = eventEnd - eventStart;

                
                if (vevent.component.hasProperty('rrule')) {
                  const iterator = vevent.iterator();
                  let next;
                  while ((next = iterator.next())) {
                    const occDate = next.toJSDate();
                    if (occDate > rangeEnd) break;
                    if (occDate < rangeStart) continue;
                    const occEndDate = new Date(occDate.getTime() + duration);
                    let [courseCode, courseName] = vevent.summary.split(" - ");
                    const description = vevent.component.getFirstPropertyValue("description") || "";
                    let occ = (description.match(/OCC\d+/) || [""])[0];
                    let lecturer = (description.match(/Lecturer: (.*)/) || ["", ""])[1];
                    let location = vevent.component.getFirstPropertyValue("location") || "";
    // Check if a color theme override is active
    let selectedTheme = document.getElementById('colorThemeDropdown')
                          ? document.getElementById('colorThemeDropdown').value
                          : "default";
    let eventColor;
    if (selectedTheme === "classic") {
  eventColor = "#fcca46"; // Classic yellow
  eventColorPale = eventColor;

} else if (selectedTheme === "beigeTan") {
  eventColor = "#8b5e3c"; // Warm brown
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "tealOrange") {
  eventColor = "#ffaa45"; // Bright orange
  eventColorPale = eventColor;

} else if (selectedTheme === "midnightPurple") {
  eventColor = "#d8b5ff"; // Soft pastel purple
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "forestGreen") {
  eventColor = "#c8e6c9"; // Light green
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "blackWhite") {
  eventColor = "#ffffff"; // White
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else {
  eventColor = vevent.component.getFirstPropertyValue("color")
               ? `#${vevent.component.getFirstPropertyValue("color").slice(2)}`
               : "#2196F3"; // Default blue
  eventColorPale = makeColorPaler(eventColor, 0.2);
}

    // Optionally, make the color a bit paler for the background

                    let eventtype = vevent.component.getFirstPropertyValue("categories") || "";
                    
                    fcEvents.push({
                      title: courseCode,
                      start: occDate,
                      end: occEndDate,
                      backgroundColor: eventColorPale,
                      borderColor: eventColorPale,
                      extendedProps: { courseCode, courseName, occ, lecturer, location, eventtype,eventColor }
                    });
                  }
                } else {
                  if (eventStart >= rangeStart && eventStart <= rangeEnd) {
                    let [courseCode, courseName] = vevent.summary.split(" - ");
                    const description = vevent.component.getFirstPropertyValue("description") || "";
                    let occ = (description.match(/OCC\d+/) || [""])[0];
                    let lecturer = (description.match(/Lecturer: (.*)/) || ["", ""])[1];
                    let location = vevent.component.getFirstPropertyValue("location") || "";
    // Check if a color theme override is active
    let selectedTheme = document.getElementById('colorThemeDropdown')
                          ? document.getElementById('colorThemeDropdown').value
                          : "default";
    let eventColor;
    if (selectedTheme === "classic") {
  eventColor = "#fcca46"; // Classic yellow
  eventColorPale = eventColor;

} else if (selectedTheme === "beigeTan") {
  eventColor = "#8b5e3c"; // Warm brown
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "tealOrange") {
  eventColor = "#ffa500"; // Bright orange
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "midnightPurple") {
  eventColor = "#d8b5ff"; // Soft pastel purple
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else if (selectedTheme === "forestGreen") {
  eventColor = "#c8e6c9"; // Light green
  eventColorPale = makeColorPaler(eventColor, 0.2);

} else {
  eventColor = vevent.component.getFirstPropertyValue("color")
               ? `#${vevent.component.getFirstPropertyValue("color").slice(2)}`
               : "#2196F3"; // Default blue
  eventColorPale = makeColorPaler(eventColor, 0.2);
}

                    let eventtype = vevent.component.getFirstPropertyValue("categories") || "";

                    
                    fcEvents.push({
                      title: courseCode,
                      start: eventStart,
                      end: eventEnd,
                      backgroundColor: eventColorPale,
                      borderColor: eventColorPale,
                      extendedProps: { courseCode, courseName, occ, lecturer, location, eventtype,eventColor }
                    });
                  }
                }
              });
              successCallback(fcEvents);
      setTimeout(() => {
        scaleTimeline();
      }, 0);
    })
            .catch(err => {
              console.error('Error loading ICS file', err);
              failureCallback(err);
            });
        },
        eventDidMount: function (info) {
          const themeKey = document.getElementById('colorThemeDropdown').value;
          const theme = themes[themeKey] || themes.default;
          console.log(themeKey);

            info.el.style.borderRadius = '14px';
info.el.style.padding = '8px';
info.el.style.overflow = 'hidden';
    info.el.style.border = 'none';

    // Deconstruct extended props from the event (from ICS parsing)
    const { courseCode, courseName, occ, lecturer, location, eventtype, eventColor } = info.event.extendedProps;
        // Build event content – override event colors if a theme is active (e.g. classic)
        let usedEventColor = theme.eventBackground ? theme.eventBackground : eventColor;
    let usedTextColor = theme.eventTextColor ? theme.eventTextColor : '#000';

  // Build the content as a flex container with two parts: top and bottom.
  let content = `<div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">`;
  
  // Top section for course info and OCC (left aligned)
  content += `<div style="color:${usedTextColor};">`;
    content += `<div style="font-weight:bold;">`;
      content += `<span style="margin-right: 5px;"><b>${courseCode}</b></span>`;
      content += `<span>${courseName}</span>`;
    content += `</div>`;
  
    if (document.getElementById('toggleLecturer').checked)
      content += `<div style="color:${usedTextColor};">${lecturer}</div>`;
    if (document.getElementById('toggleLocation').checked)
      content += `<div style="color:${usedTextColor};">Location: ${location}</div>`;
    if (document.getElementById('toggleOCC').checked)
      content += `<div style="text-align:left; background-color:${usedEventColor};color:${usedTextColor}; border-radius:20px; margin-top:4px;margin-right:5px; padding:3px 8px; display:inline-block; font-weight:bold;box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;">${occ}</div>`;
    if (document.getElementById('toggleCategory').checked)
      content += `<div style="text-align:left; background-color:${usedEventColor};color:${usedTextColor}; border-radius:20px; margin-top:4px; padding:3px 8px; display:inline-block; font-weight:bold;box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;">${eventtype}</div>`;
    
    content += `</div>`;



    if (document.getElementById('toggleTime').checked)
      content += `<div style="text-align: right;color:${usedTextColor || 'white'}">${info.timeText}</div>`;
    content += `</div>`;
    info.el.innerHTML = content;
}

       });
      
      // Render the calendar.
      calendar.render();
scaleTimeline(); // Ensure scaling is applied

    


      // Function to scale the timeline to fit inside the 320x600 viewport.
      function scaleTimeline() {
        calendar.setOption('dayHeaderFormat', getDayHeaderFormat());
  // Show the loading overlay before starting recalculations.
  const loadingOverlay = document.getElementById("loadingOverlay");
  loadingOverlay.style.display = "flex";
  calendarEl.classList.remove('scaled');
  calendarEl.style.transform = "";

  setTimeout(function () {
    const isMobile = window.innerWidth <= 768;
    const isPortrait = window.innerHeight > window.innerWidth;

    let viewportWidth, viewportHeight;

    if (isMobile) {
      viewportWidth = 360;
      viewportHeight = 460;
    } else {
      viewportWidth = isPortrait ? 700 : 800;
      viewportHeight = isPortrait ? 750 : 450;
    }

    const calWidth = calendarEl.offsetWidth;
    const calHeight = calendarEl.offsetHeight;
    const scaleFactor = Math.min(viewportWidth / calWidth, viewportHeight / calHeight);

    // Calculate horizontal offset
    const offsetX = (viewportWidth - calWidth * scaleFactor) / 2;
    // Calculate vertical offset (already done)
    const offsetY = (viewportHeight - calHeight * scaleFactor) / 2;

    // Apply both horizontal and vertical translation with scaling.
    calendarEl.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scaleFactor})`;
    calendarEl.classList.add("scaled");

    // Hide the loading overlay once scaling is complete.
    loadingOverlay.style.display = "none";
  }, 500);



}
        updateCalendarDimensions();
        calendar.updateSize();
        scaleTimeline();


      
  // Listen for changes on the color theme dropdown
document.getElementById('colorThemeDropdown').addEventListener('change', function() {
  applyTheme(this.value);
  updateAdditionalThemeElements();
  calendar.refetchEvents();
  scaleTimeline();

  // Update URL only if not initializing
  if (!isInitializing) {
    updateURL({ theme: this.value });
  }
});
      scaleTimeline();
      
      // Update toggles to trigger recalculations with the loading overlay.
      document.querySelectorAll('.cupertino-switch input').forEach(toggle => {
        toggle.addEventListener('change', () => {
          if (toggle.id === 'toggleWeekend') {
            calendar.setOption('weekends', toggle.checked);
          }
          if (toggle.id === 'toggleDateHeader') {
            calendar.setOption('dayHeaderFormat', getDayHeaderFormat());
          }
          calendar.refetchEvents();
          scaleTimeline();

          // Update URL only if not initializing
          if (!isInitializing) {
            updateURL({ [toggle.id]: toggle.checked ? '1' : '0' });
          }
        });
      });
      
      var timeSlider = document.getElementById('timeRangeSlider');
      noUiSlider.create(timeSlider, {
        start: [8, 19],
        connect: true,
        range: {
          'min': 0,
          'max': 24
        },
        step: 1,
        tooltips: [true, true],
        format: {
          to: function(value) { return Math.floor(value); },
          from: function(value) { return Number(value); }
        }
      });
      
      timeSlider.noUiSlider.on('change', function (values) {
        const startHour = values[0];
        const endHour = values[1];
        document.getElementById('timeRangeStartLabel').innerText = 
          (startHour < 10 ? "0" : "") + startHour + ":00";
        document.getElementById('timeRangeEndLabel').innerText = 
          (endHour < 10 ? "0" : "") + endHour + ":00";
        calendar.setOption('slotMinTime', startHour + ":00:00");
        calendar.setOption('slotMaxTime', endHour + ":00:00");
        calendar.refetchEvents();
        updateCalendarDimensions();
        calendar.updateSize();
        scaleTimeline();

        // Update URL only if not initializing
        if (!isInitializing) {
          updateURL({ timeStart: startHour, timeEnd: endHour });
        }
      });

      window.addEventListener('resize', scaleTimeline);
    });

    function updateAdditionalThemeElements() {
  const themeKey = document.getElementById('colorThemeDropdown').value;
  const theme = themes[themeKey] || themes.default;
  // Update calendar header container if needed
  const calendarHeader = document.getElementById('calendarHeader');
  if (calendarHeader && theme.headerBackground) {
    calendarHeader.style.backgroundColor = theme.headerBackground;
    calendarHeader.style.color = theme.textColor;
  }
}


  </script>
</body>
</html>
