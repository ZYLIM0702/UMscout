<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- FullCalendar CSS and JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <!-- ical.js for ICS parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
  <!-- noUiSlider CSS and JS for dual slider -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <!-- Font Awesome for icons (example) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
        :root {
    --fc-today-bg-color: transparent;
    }
body {
  margin: 0; /* Remove default margin */
  min-height: 100vh; /* Full viewport height */
  display: flex;
  flex-direction: column;
  justify-content: flex-end; /* Push content to the bottom */
  font-family: Arial, sans-serif;
  background-color: #000;
  color: white;
}
    /* The “real” calendar container with a fixed height and dynamic width */
    #calendar {
      height: 1900px; /* fixed height */
    }
    /* This viewport will show only the timeline (no header) at fixed size */
    #timelineViewport {
  width: 360px;
  height: 500px;
  overflow: hidden;
  position: relative;
  margin: 20px auto;
}

/* Tablet (iPad) - Adjusts based on orientation */
@media (min-width: 769px) {
  #timelineViewport {
    width: 900px;
    height: 600px;
  }

  @media (orientation: portrait) {
    #timelineViewport {
      width: 800px;
      height: 900px;
    }
  }
}
    /* Loading overlay styles */
    #loadingOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgb(0, 0, 0);
      z-index: 10;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* FullCalendar scaling style */
    #calendar.scaled {
      transform-origin: top left;
    }
    /* Other styles remain unchanged... */
    .fc .fc-view-harness {
      background-color: #fff;
      border-radius: 20px;
      overflow: hidden;
    }
    .fc .fc-toolbar-title { color: white; font-size: 4rem;}
    .fc .fc-button-group {
      border-radius: 20px;
      overflow: hidden;
    }
    .fc .fc-button-primary {
      background-color: #fff;
      color: #000;
      border: none;
    }
    .card-event {
      border-radius: 14px !important;
      padding: 8px;
      border: none !important;
      color: #fff;
      overflow: hidden;
    }
    .toggle-scroll {
    text-align: center;
    justify-content: space-evenly;
    display: flex
;
    flex-direction: row;
}
    .toggle-item {
      display: inline-block;
      margin: 0 5px;
      text-align: center;
      align-items: center;
      align-self: center;
    }
    .toggle-item i { font-size: 1.2rem; color: #fff; }
    .cupertino-switch {
        margin-top: 10px;
      position: relative;
      display: inline-block;
      width: 35px;
      height: 20px;
      vertical-align: middle;
    }
    .fc-event-main{
        display: none;
    }
    .cupertino-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #e9e9eb;
      border-radius: 16px;
      transition: .4s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 0px;
      background-color: #fff;
      border-radius: 50%;
      transition: .4s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 0.5px rgba(0, 0, 0, 0.1);
    }
    .noUi-tooltip { display: none; }
    input:checked + .slider {
      background-color: #573aff;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 0.5px rgba(0, 0, 0, 0.1);
    }
    .noUi-target {
      background: #e9e9eb;
      border-radius: 8px;
      border: none;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .noUi-connect { background: #573aff; }
    .noUi-horizontal { height: 6px; }
    .noUi-handle:after, .noUi-handle:before { background: none; }
    .noUi-horizontal .noUi-handle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
    }
    .noUi-handle:focus { outline: none; transform: scale(1.15); }
    .slider-row {
    display: flex;
    gap: 20px;
    margin: 40px 20px 0px;
    border-radius: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
    justify-content: center;
    align-items: flex-start
}
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: white;
      letter-spacing: -0.08px;
      margin-top: 8px;
    }
    select {
      padding: 8px 12px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #fff;
      font-size: 13px;
      color: #1d1d1f;
      transition: border-color 0.2s ease;
    }
    select:focus {
      outline: none;
      border-color: #573aff;
      box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
    }
    .fc-col-header-cell {
      background-color: #ae86f9;
      color: #fff;
      font-weight: bold;
      padding: 10px 0 !important;
    }
    .fc .fc-timegrid-slot-minor { border-top-style: none; }
    .fc-theme-standard td, .fc-theme-standard th { border: 1px solid #e5e5e5; }
    .fc-timegrid-axis {
      background-color: #86b0f9 !important;
      color: #fff !important;
      font-weight: bold;
    }
    .fc-direction-ltr .fc-timegrid-slot-label-frame {
      text-align: left;
      color: #fff;
      font-weight: bold;
      margin: 15px;
    }
    .fc-direction-ltr .fc-timegrid-col-events { margin: 1px 2px 0px 2px; }
  </style>
</head>
<body>
  <!-- Container for header outside the timeline viewport -->
  <div id="calendarHeader" style="max-width:900px; margin:20px auto; text-align:center; color:#fff;"></div>
  <!-- Timeline viewport for the timeline part only -->
  <div id="timelineViewport">
    <!-- Loading overlay with spinner -->
    <div id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    <div id="calendar" ></div>
  </div>
    <!-- Horizontally scrollable toggles -->
    <div class="settings-panel">
        <div class="toggle-scroll">
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-days"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleOCC" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-list"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleCategory" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-user"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleLecturer">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-clock"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleTime" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-location-dot"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleLocation" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-check"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleWeekend">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-item">
            <div><i class="fa-solid fa-calendar-alt"></i></div>
            <label class="cupertino-switch">
              <input type="checkbox" id="toggleDateHeader">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      
  <!-- Slider and dropdown row -->
  <div class="slider-row">
    <div style="flex:1">
      <div id="timeRangeSlider"></div>
      <div class="slider-labels">
        <span id="timeRangeStartLabel">08:00</span>
        <span id="timeRangeEndLabel">19:00</span>
      </div>
    </div>
    <div>
      <select id="heightRatioDropdown" style="padding: 2px; border-radius: 15px; border: none;">
        <option value="5:3">5:3</option>
        <option value="16:9">16:9</option>
        <option value="9:16">9:16</option>
        <option value="3:4">3:4</option>
        <option value="1:1">1:1</option>

      </select>
    </div>
  </div>
  <div style="text-align:center; margin: 15px 15px 30px;">
    <button id="saveImageBtn" style="padding: 10px 20px; font-size: 1rem;width: 100%;border-radius: 20px;border: none;background-color: #573aff;color: white;">Save as PNG</button>
  </div>
  

  <script>

const urlParams = new URLSearchParams(window.location.search);
const icsUrl = urlParams.get('icsUrl');


function getCacheICS(url, cacheDuration = 3600) {
  const cacheKey = 'cachedICS';
  const timestampKey = 'cachedICSTimestamp';

  // Check for cached data
  const cachedData = localStorage.getItem(cacheKey);
  const cachedTimestamp = localStorage.getItem(timestampKey);

  if (cachedData && cachedTimestamp) {
    const ageInSeconds = (Date.now() - parseInt(cachedTimestamp, 10)) / 1000;
    if (ageInSeconds < cacheDuration) {
      console.log('Returning cached ICS data');
      return Promise.resolve(cachedData);
    }
  }

  // If no valid cache exists, fetch new data
  return fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.text();
    })
    .then(data => {
      localStorage.setItem(cacheKey, data);
      localStorage.setItem(timestampKey, Date.now().toString());
      console.log('Fetched new ICS data and updated cache');
      return data;
    })
    .catch(error => {
      console.error('Error fetching ICS data:', error);
      throw error;
    });
}

    
document.getElementById('saveImageBtn').addEventListener('click', function() {
  const calendarEl = document.getElementById('calendar');
  const headerEl = calendarEl.querySelector('.fc-header-toolbar');

  // Temporarily hide the header
  if (headerEl) {
    headerEl.style.visibility = 'hidden';
  }

  // Capture the calendar element
  html2canvas(calendarEl, { scale: 2, backgroundColor: null }).then(canvas => {
    // Restore the header after capturing
    if (headerEl) {
      headerEl.style.visibility = '';
    }

    const ctx = canvas.getContext('2d');
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imgData.data;

    // Find the first non-empty row
    let top = 0;
    for (let y = 0; y < canvas.height; y++) {
      let rowEmpty = true;
      for (let x = 0; x < canvas.width; x++) {
        const alpha = pixels[(y * canvas.width + x) * 4 + 3]; // Get alpha channel
        if (alpha !== 0) { // If pixel is not transparent
          rowEmpty = false;
          break;
        }
      }
      if (!rowEmpty) {
        top = y;
        break;
      }
    }

    // Crop the canvas
    const croppedCanvas = document.createElement('canvas');
    const croppedCtx = croppedCanvas.getContext('2d');
    const height = canvas.height - top; // New height after trimming

    croppedCanvas.width = canvas.width;
    croppedCanvas.height = height;
    croppedCtx.putImageData(ctx.getImageData(0, top, canvas.width, height), 0, 0);

    // Convert cropped canvas to Base64
    const base64Image = croppedCanvas.toDataURL('image/png').replace('data:image/png;base64,', '');

    // Send the Base64 string to Flutter
    if (window.saveImage) {
      window.saveImage.postMessage(base64Image);
    } else {
      console.error('Flutter JavaScript channel not available.');
    }
  });
});



    document.addEventListener('DOMContentLoaded', function () {
      // Fixed calendar height
      const fixedHeight = 1900;
      let fixedWidth = fixedHeight; // default, updated based on ratio
      
      // Compute fixed width based on the ratio dropdown
      function updateCalendarDimensions() {
  const fixedHeight = 1900;
  const ratioValue = document.getElementById('heightRatioDropdown').value; // e.g. "9:16"
  const [w, h] = ratioValue.split(':').map(Number);
  const fixedWidth = fixedHeight * (w / h);

  // Force #calendar to that width
  const calendarEl = document.getElementById('calendar');
  calendarEl.style.width = fixedWidth + "px";

  // Adjust font size based on the ratio selected
  let fontSize;
  switch (ratioValue) {
    case "16:9":
      fontSize = "2rem";
      break;
    case "9:16":
      fontSize = "1.2rem";
      break;
    case "5:3":
      fontSize = "1.8rem";
      break;
    case "3:4":
      fontSize = "1.2rem";
      break;
    case "1:1":
      fontSize = "1.5rem";
      break;
    default:
      fontSize = "1.0rem";
  }
  calendarEl.style.fontSize = fontSize;

  // Force the harness
  const harnessEl = calendarEl.querySelector('.fc-view-harness');
  if (harnessEl) {
    harnessEl.style.width = fixedWidth + "px";
    harnessEl.style.maxWidth = fixedWidth + "px";
  }

  // Force the timegrid table
  const timelineTable = calendarEl.querySelector('.fc-timegrid-cols > table');
  if (timelineTable) {
    timelineTable.style.width = fixedWidth + "px";
    timelineTable.style.maxWidth = fixedWidth + "px";
  }
}

  
      updateCalendarDimensions();
      
      // Listen for changes in the dropdown to adjust dimensions accordingly.
      document.getElementById('heightRatioDropdown').addEventListener('change', function(){
        calendar.refetchEvents();
        updateCalendarDimensions();
        calendar.updateSize();
        scaleTimeline();
      });
      
      // Function to determine the day header format based on toggle state.
      function getDayHeaderFormat() {
        return document.getElementById('toggleDateHeader').checked
          ? { weekday: 'short', month: 'numeric', day: 'numeric' }
          : { weekday: 'short' };
      }
      
      // Create the calendar instance.
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        height: fixedHeight,
        headerToolbar: { left: '', center: '', right: 'prev,next' },
        datesSet: function(dateInfo) {
    scaleTimeline();
    calendar.refetchEvents();
    updateCalendarDimensions();
    calendar.updateSize();
  },

        allDaySlot: false,
        slotMinTime: "08:00:00",
        slotMaxTime: "19:00:00",
        expandRows: true,
        weekends: document.getElementById('toggleWeekend').checked,
        events: function(fetchInfo, successCallback, failureCallback) {
          getCacheICS(icsUrl)
    .then(data => {
              const jcalData = ICAL.parse(data);
              const comp = new ICAL.Component(jcalData);
              const vevents = comp.getAllSubcomponents('vevent');
              const fcEvents = [];
              const rangeStart = fetchInfo.start;
              const rangeEnd = fetchInfo.end;
              
              vevents.forEach(event => {
                const vevent = new ICAL.Event(event);
                const eventStart = vevent.startDate.toJSDate();
                const eventEnd = vevent.endDate.toJSDate();
                const duration = eventEnd - eventStart;

                
                if (vevent.component.hasProperty('rrule')) {
                  const iterator = vevent.iterator();
                  let next;
                  while ((next = iterator.next())) {
                    const occDate = next.toJSDate();
                    if (occDate > rangeEnd) break;
                    if (occDate < rangeStart) continue;
                    const occEndDate = new Date(occDate.getTime() + duration);
                    let [courseCode, courseName] = vevent.summary.split(" - ");
                    const description = vevent.component.getFirstPropertyValue("description") || "";
                    let occ = (description.match(/OCC\d+/) || [""])[0];
                    let lecturer = (description.match(/Lecturer: (.*)/) || ["", ""])[1];
                    let location = vevent.component.getFirstPropertyValue("location") || "";
                    let eventColor = vevent.component.getFirstPropertyValue("color")
                      ? `#${vevent.component.getFirstPropertyValue("color").slice(2)}`
                      : "#2196F3";
                    let eventtype = vevent.component.getFirstPropertyValue("categories") || "";
                    
                    fcEvents.push({
                      title: courseCode,
                      start: occDate,
                      end: occEndDate,
                      backgroundColor: eventColor,
                      borderColor: eventColor,
                      extendedProps: { courseCode, courseName, occ, lecturer, location, eventtype }
                    });
                  }
                } else {
                  if (eventStart >= rangeStart && eventStart <= rangeEnd) {
                    let [courseCode, courseName] = vevent.summary.split(" - ");
                    const description = vevent.component.getFirstPropertyValue("description") || "";
                    let occ = (description.match(/OCC\d+/) || [""])[0];
                    let lecturer = (description.match(/Lecturer: (.*)/) || ["", ""])[1];
                    let location = vevent.component.getFirstPropertyValue("location") || "";
                    let eventColor = vevent.component.getFirstPropertyValue("color")
                      ? `#${vevent.component.getFirstPropertyValue("color").slice(2)}`
                      : "#2196F3";
                    let eventtype = vevent.component.getFirstPropertyValue("categories") || "";

                    
                    fcEvents.push({
                      title: courseCode,
                      start: eventStart,
                      end: eventEnd,
                      backgroundColor: eventColor,
                      borderColor: eventColor,
                      extendedProps: { courseCode, courseName, occ, lecturer, location, eventtype }
                    });
                  }
                }
              });
              successCallback(fcEvents);
      setTimeout(() => {
        scaleTimeline();
      }, 0);
    })
            .catch(err => {
              console.error('Error loading ICS file', err);
              failureCallback(err);
            });
        },
        eventDidMount: function (info) {
            info.el.style.borderRadius = '14px';
info.el.style.padding = '8px';
info.el.style.border = 'none';
info.el.style.color = '#fff';
info.el.style.overflow = 'hidden';
  const { courseCode, courseName, occ, lecturer, location, eventtype } = info.event.extendedProps;
  // Build the content as a flex container with two parts: top and bottom.
  let content = `<div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">`;
  
  // Top section for course info and OCC (left aligned)
  content += `<div>`;
    content += `<div style="font-weight:bold;">`;
      content += `<span style="margin-right: 5px;"><b>${courseCode}</b></span>`;
      content += `<span>${courseName}</span>`;
    content += `</div>`;
  
  if (document.getElementById('toggleLecturer').checked)
    content += `<div>${lecturer}</div>`;
  if (document.getElementById('toggleLocation').checked)
    content += `<div>Location: ${location}</div>`;
    if (document.getElementById('toggleOCC').checked)
  content += `<div style="text-align:left; background-color:rgba(0, 0, 0, 0.15); border-radius:10px; margin-top:4px;margin-right:5px; padding:3px 5px; display:inline-block; font-weight:bold;">${occ}</div>`;

if (document.getElementById('toggleCategory').checked)
  content += `<div style="text-align:left; background-color:rgba(0, 0, 0, 0.15); border-radius:10px; margin-top:4px; padding:3px 5px; display:inline-block; font-weight:bold;">${eventtype}</div>`;

content += `</div>`;


  // Bottom section for time, aligned right
  if (document.getElementById('toggleTime').checked)
    content += `<div style="text-align: right;">${info.timeText}</div>`;

  content += `</div>`;
  info.el.innerHTML = content;
}

       });
      
      // Render the calendar.
      calendar.render();
      
      
      // Function to scale the timeline to fit inside the 320x600 viewport.
      function scaleTimeline() {
        calendar.setOption('dayHeaderFormat', getDayHeaderFormat());
  // Show the loading overlay before starting recalculations.
  const loadingOverlay = document.getElementById("loadingOverlay");
  loadingOverlay.style.display = "flex";
  calendarEl.classList.remove('scaled');
  calendarEl.style.transform = "";

  setTimeout(function () {
    const isMobile = window.innerWidth <= 768;
    const isPortrait = window.innerHeight > window.innerWidth;

    let viewportWidth, viewportHeight;

    if (isMobile) {
      viewportWidth = 360;
      viewportHeight = 500;
    } else {
      viewportWidth = isPortrait ? 800 : 900;
      viewportHeight = isPortrait ? 900 : 600;
    }

    const calWidth = calendarEl.offsetWidth;
    const calHeight = calendarEl.offsetHeight;
    const scaleFactor = Math.min(viewportWidth / calWidth, viewportHeight / calHeight);

    // Calculate horizontal offset
    const offsetX = (viewportWidth - calWidth * scaleFactor) / 2;
    // Calculate vertical offset (already done)
    const offsetY = (viewportHeight - calHeight * scaleFactor) / 2;

    // Apply both horizontal and vertical translation with scaling.
    calendarEl.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scaleFactor})`;
    calendarEl.classList.add("scaled");

    // Hide the loading overlay once scaling is complete.
    loadingOverlay.style.display = "none";
  }, 500);


}
      
      scaleTimeline();
      
      // Update toggles to trigger recalculations with the loading overlay.
      document.querySelectorAll('.cupertino-switch input').forEach(toggle => {
        toggle.addEventListener('change', () => {
          if (toggle.id === 'toggleWeekend') {
            calendar.setOption('weekends', toggle.checked);
          }
          if (toggle.id === 'toggleDateHeader') {
            calendar.setOption('dayHeaderFormat', getDayHeaderFormat());
          }
          calendar.refetchEvents();
          scaleTimeline();
        });
      });
      
      var timeSlider = document.getElementById('timeRangeSlider');
      noUiSlider.create(timeSlider, {
        start: [8, 19],
        connect: true,
        range: {
          'min': 0,
          'max': 24
        },
        step: 1,
        tooltips: [true, true],
        format: {
          to: function(value) { return Math.floor(value); },
          from: function(value) { return Number(value); }
        }
      });
      
      timeSlider.noUiSlider.on('change', function (values) {
        let startHour = values[0];
        let endHour = values[1];
        document.getElementById('timeRangeStartLabel').innerText = (startHour < 10 ? "0" : "") + startHour + ":00";
        document.getElementById('timeRangeEndLabel').innerText = (endHour < 10 ? "0" : "") + endHour + ":00";
        calendar.setOption('slotMinTime', startHour + ":00:00");
        calendar.setOption('slotMaxTime', endHour + ":00:00");
        calendar.refetchEvents();
        updateCalendarDimensions();
        calendar.updateSize();
        scaleTimeline();
      });
      
      window.addEventListener('resize', scaleTimeline);
    });



  </script>
</body>
</html>
